generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Workflows {
  id          String   @id @default(uuid())
  name        String
  description String?
  version     String   @default(uuid())

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  tasks       Tasks[]
  executions  WorkflowExecution[]
  
  @@map("workflows")
}

model Tasks {
  id          String   @id @default(uuid())
  workflowId  String
  name        String
  type        String?
  config      Json?
  createdAt   DateTime @default(now())
  
  workflow    Workflows @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  
  // DAG edges (explicit + directed)
  dependencies TaskDependency[] @relation("TaskDependsOn")
  dependents   TaskDependency[] @relation("TaskDependedBy")

  executions  TaskExecution[]

  @@map("tasks")
}

model TaskDependency {
  id                String @id @default(uuid())

  taskId            String
  dependsOnTaskId   String

  // The task that is waiting
  task              Tasks @relation(
    "TaskDependsOn",
    fields: [taskId],
    references: [id],
    onDelete: Cascade
  )

  // The task that must complete first
  dependsOn         Tasks @relation(
    "TaskDependedBy",
    fields: [dependsOnTaskId],
    references: [id],
    onDelete: Cascade
  )

  @@unique([taskId, dependsOnTaskId])
  @@map("task_dependencies")
}

model WorkflowExecution {
  id          String   @id @default(uuid())
  workflowId  String
  status      String   // "RUNNING", "COMPLETED", "FAILED"
  startedAt   DateTime @default(now())
  completedAt DateTime?
  
  workflow    Workflows @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  taskExecutions TaskExecution[]
  
  @@map("workflow_executions")
}

model TaskExecution {
  id                  String   @id @default(uuid())
  workflowExecutionId String
  taskId              String   // Reference to Task.id (UUID)
  state               String   // "PENDING", "RUNNING", "COMPLETED", "FAILED", "BLOCKED", "RETRYING"
  retryCount          Int      @default(0)
  maxRetries          Int      @default(3)
  nextRetryAt         DateTime?
  startedAt           DateTime?
  completedAt         DateTime?
  error               String?
  
  workflowExecution   WorkflowExecution @relation(fields: [workflowExecutionId], references: [id], onDelete: Cascade)
  task                Tasks             @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@index([state])
  @@map("task_executions")
}
